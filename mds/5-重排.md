# 重排

## 一、物品相似性的度量

重排的目的是选出多样化的物品，即需要物品不相似。粗排的后处理也需要尽可能地选择多样性高的算法。

- 基于物品的属性标签
  - 属性标签：类目、品牌、关键词；物品的标签由cv/nlp算法推断得到
  - 两个物品的相似度可以根据类目的重合度计算
- 基于物品的向量表征
  - 双塔模型学到的向量——不好
    - 物品塔模型得到的物品向量，无法很好地表征新的物品和长尾物品。
    - 双塔模型训练的目的是更好地匹配用户的兴趣，而不是分类多样的物品
  - 基于内容的向量——好
    - CLIP提取图文信息，同一篇笔记的图片和文字是正样本，其余是负样本。

## 二、MMR

Maximal Marginal Relevance，最大边界相关算法。从n个候选物品选出k个多样性高的。

### 步骤

- 将n个物品分为集合S和R，S表示选中的多样性物品，初始化为空集；R表示未选中的，初始化为全集。

  - 第一轮将reward最高的i放入S

- 计算R中每个物品i的Marginal Relevance：
  $$
  MR_i=\theta \cdot reward_i-(1-\theta)\cdot max_{j\in S} sim(i,j).
  $$
  当i和S中最相似的物品相似度很高，则MR值很低，起到抑制作用。

- MMR：$argmax_{i\in R}\ MR_i$. 找到MR值最大的物品i，放入S中。

  - 直到S中有k个物品

### 滑动窗口优化

**当S中物品越来越多**，新计算的物品i和j的最大相似度都很大，则MR的第二项很小，起作用的变成了reward。

- 设置一个滑动窗口W，选择最近进入S的M个物品，用W代替S计算MR。
- 最近：暴露给用户的n个物品中，没必要都不相似，只要**距离近的不相似**即可。第一个物品和第n个物品可以相似。

## 三、重排的规则

- 最多连续出现k篇某种笔记
  - 笔记的类型可以是图文、视频等
- 每k篇笔记最多出现1篇推广笔记
- 前t篇笔记最多出现k篇某种笔记
  - 前t篇比较重要，是用户一打开就能看到的，因此对于某些电商类笔记要限制数量

在MMR中先从R中按照规则剔除一些物品。

## 四、DDP

**DPP**(Determinantal Point Process)行列式点过程，将复杂的概率计算转换成简单的行列式计算。能从一个集合中选出尽量多样化的物品。

### 数学基础

#### 超平行体

一组向量$v_1,\cdots,v_k \in R^d$可以确定k维超平行体（k<=d），记作:$P(v_1,\cdots,v_k)=\{\alpha_1 v_1+\cdots+\alpha_kv_k | 0 \le \alpha_1,\cdots,\alpha_k \le 1\}.$

> 例如：二维超平行体是一个平行四边形，两个相邻的边是向量$v_1,v_2$. 平行四边形内的任意点都可以表示为两个向量的加权和，权重在0~1之间。

超平行体的基向量必须线性无关，否则体积为0. 当基向量两两正交时，体积最大。如果是单位向量，体积最大为1.

因此可以用超平行体的体积，衡量不同基向量的线性相关程度。将k个物品表征成基向量，计算它们组成的超平行体的体积。如果体积为1，表示这k个物品两两正交，多样性好。

#### 超平行体体积计算

k个单位向量作为矩阵$V\in R^{d\times k}$的列，则行列式和体积的关系满足：$det(V^\top V)=vol(P(v_1,\cdots,v_k))^2$. 即可以用行列式衡量物品的多样性。

### DDP用在推荐系统

为了从n个物品中选出k个多样性最高的，将k个物品集合记作S. 计算集合S的分数，由k个物品的reward（用户兴趣值）和多样化程度计算得到：
$$
argmax_{S:|S|=k} \theta \cdot (\sum_{j \in S}reward_j)+(1-\theta)\cdot log\ det(V_S^\top V_S)
$$
用户兴趣越高，多样化程度越高，分数越大。

#### 求解

DDP是从集合1~n中选出大小为k的子集S，是np hard问题，不能精确求解。

用贪心算法，每次选取一个物品i加入集合S中，让下面公式值最大：
$$
argmax_{S:|S|=k} \theta \cdot (\sum_{j \in S}reward_j)+(1-\theta)\cdot log\ det(A_{S\cup{i}})
$$
其中A是$V_S^\top V_S$计算后的$k\times k$矩阵。

上述暴力算法的时间复杂度是$O(n^2d+nk^4)$，hulu算法能将到$O(n^2d+nk^2)$.

计算n个物品的A->$O(n^2d)$，用Cholesky分解计算所有的行列式$O(nk^2)$

#### 滑动窗口和规则约束

同样，当S越来越多，S内的向量趋近于线性相关，体积坍缩到0，DDP就失效了。

可以用上面提到的滑动窗口W，选出最近的m个物品计算行列式。

同样，重拍的固定规则也可以用来剔除不符合要求的物品。